<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>បញ្ជីឈ្មោះសិស្ស - Firebase Realtime Database</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Kantumruy Pro for Khmer text -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f3f4f6;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .skeleton {
            background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="bg-blue-700 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i data-lucide="users" class="w-8 h-8"></i>
                <h1 class="text-2xl font-bold">ប្រព័ន្ធគ្រប់គ្រងសិស្ស</h1>
            </div>
            <div class="text-sm opacity-80 hidden sm:block">
                Firebase Realtime Database
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Search/Filter Section -->
        <div class="mb-8 flex flex-col sm:flex-row gap-4 justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
                <i data-lucide="list" class="w-5 h-5"></i>
                បញ្ជីឈ្មោះសិស្ស (ជំនាន់ ទី៣)
                <span id="student-count" class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full hidden">0</span>
            </h2>
            <div class="relative w-full sm:w-64">
                <input type="text" id="search-input" placeholder="ស្វែងរកឈ្មោះ..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Skeleton items generated by JS -->
        </div>

        <!-- Student Grid -->
        <div id="student-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden">
            <!-- Cards will be injected here -->
        </div>

        <!-- No Data State -->
        <div id="no-data" class="hidden text-center py-20">
            <div class="bg-white p-8 rounded-full inline-block mb-4 shadow-sm">
                <i data-lucide="database" class="w-12 h-12 text-gray-300"></i>
            </div>
            <p class="text-gray-500 text-lg">មិនមានទិន្នន័យជំនាន់ទី៣ ទេ</p>
        </div>

        <!-- Error State -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
            <strong class="font-bold">មានបញ្ហា!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <span id="toast-message">រក្សាទុកបានជោគជ័យ!</span>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Configuration provided by user
        const firebaseConfig = {
            apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s",
            authDomain: "dilistname.firebaseapp.com",
            databaseURL: "https://dilistname-default-rtdb.firebaseio.com",
            projectId: "dilistname",
            storageBucket: "dilistname.firebasestorage.app",
            messagingSenderId: "897983357871",
            appId: "1:897983357871:web:42a046bc9fb3e0543dc55a",
            measurementId: "G-NQ798D9J6K"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            
            // Query to filter students where 'ជំនាន់' is equal to 'ទី៣'
            const studentsRef = query(ref(db, 'students'), orderByChild('ជំនាន់'), equalTo('ទី៣'));

            const grid = document.getElementById('student-grid');
            const loading = document.getElementById('loading');
            const noData = document.getElementById('no-data');
            const searchInput = document.getElementById('search-input');
            const countBadge = document.getElementById('student-count');
            
            // Generate Skeletons
            loading.innerHTML = Array(8).fill(0).map(() => `
                <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 p-4">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-16 h-16 rounded-full skeleton"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-4 w-3/4 skeleton rounded"></div>
                            <div class="h-3 w-1/2 skeleton rounded"></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="h-3 w-full skeleton rounded"></div>
                        <div class="h-3 w-full skeleton rounded"></div>
                    </div>
                </div>
            `).join('');

            // Fetch Data
            onValue(studentsRef, (snapshot) => {
                loading.classList.add('hidden');
                
                if (snapshot.exists()) {
                    let students = [];
                    // Important: Use forEach to preserve the KEY (student ID)
                    snapshot.forEach((childSnapshot) => {
                        const studentData = childSnapshot.val();
                        // Store the key so we can update later
                        studentData.key = childSnapshot.key;
                        students.push(studentData);
                    });

                    window.allStudents = students;
                    renderStudents(students);
                } else {
                    grid.classList.add('hidden');
                    noData.classList.remove('hidden');
                    countBadge.classList.add('hidden');
                }
            }, (error) => {
                loading.classList.add('hidden');
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                errorDiv.classList.remove('hidden');
                errorText.textContent = "មិនអាចទាញទិន្នន័យបានទេ: " + error.message;
                console.error(error);
            });

            // Make function available globally for button clicks
            window.toggleEdit = (key) => {
                const displayDiv = document.getElementById(`tg-display-${key}`);
                const formDiv = document.getElementById(`tg-form-${key}`);
                if (displayDiv && formDiv) {
                    displayDiv.classList.add('hidden');
                    formDiv.classList.remove('hidden');
                    // Focus input
                    const input = document.getElementById(`tg-input-${key}`);
                    if(input) input.focus();
                }
            };

            window.cancelEdit = (key) => {
                const displayDiv = document.getElementById(`tg-display-${key}`);
                const formDiv = document.getElementById(`tg-form-${key}`);
                if (displayDiv && formDiv) {
                    displayDiv.classList.remove('hidden');
                    formDiv.classList.add('hidden');
                }
            };

            window.saveTelegram = async (key) => {
                const input = document.getElementById(`tg-input-${key}`);
                const newValue = input.value.trim();
                const btn = document.getElementById(`btn-save-${key}`);
                const originalContent = btn.innerHTML;

                try {
                    // Show loading on button
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
                    lucide.createIcons();

                    // Update to Firebase
                    const updates = {};
                    updates[`students/${key}/តេឡេក្រាម`] = newValue;
                    
                    await update(ref(db), updates);
                    
                    showToast("រក្សាទុកបានជោគជ័យ!");
                    
                    // The UI will auto-update because of onValue listener
                    // We just need to reset the view state if needed, but re-render might handle it.
                    // However, to be smooth, let's manually toggle back if re-render doesn't happen fast enough
                    // (Though usually re-render is instant)
                    
                } catch (error) {
                    console.error("Update failed", error);
                    alert("បរាជ័យក្នុងការរក្សាទុក: " + error.message);
                    btn.innerHTML = originalContent;
                }
            };

            function showToast(msg) {
                const toast = document.getElementById('toast');
                const toastMsg = document.getElementById('toast-message');
                toastMsg.innerText = msg;
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            function renderStudents(studentsList) {
                if (studentsList.length === 0) {
                    grid.classList.add('hidden');
                    noData.classList.remove('hidden');
                    countBadge.classList.add('hidden');
                    return;
                }

                grid.innerHTML = '';
                grid.classList.remove('hidden');
                noData.classList.add('hidden');
                countBadge.textContent = studentsList.length;
                countBadge.classList.remove('hidden');

                studentsList.forEach(student => {
                    const name = student['ឈ្មោះ'] || 'គ្មានឈ្មោះ';
                    const id = student['អត្តលេខ'] || 'N/A';
                    const gender = student['ភេទ'] || 'N/A';
                    const imgUrl = student['រូបថត'] || 'https://via.placeholder.com/150?text=No+Image';
                    const studentClass = student['ថ្នាក់'] || '';
                    const year = student['ឆ្នាំសិក្សា'] || '';
                    const telegram = student['តេឡេក្រាម'] || '';
                    const key = student.key;

                    let telegramLink = '#';
                    let hasTelegram = telegram && telegram.length > 0;
                    if (hasTelegram) {
                        telegramLink = telegram.startsWith('http') ? telegram : `https://${telegram}`;
                    }

                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100 card-hover transition-all duration-300 flex flex-col group';
                    
                    card.innerHTML = `
                        <div class="p-5 flex-1">
                            <div class="flex items-start space-x-4">
                                <div class="relative">
                                    <img src="${imgUrl}" alt="${name}" 
                                        class="w-20 h-20 rounded-full object-cover border-2 border-blue-100 shadow-sm bg-gray-50"
                                        onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=${id}'">
                                    <span class="absolute bottom-0 right-0 w-5 h-5 rounded-full border-2 border-white flex items-center justify-center ${gender === 'ប្រុស' ? 'bg-blue-500' : 'bg-pink-500'}">
                                        <i data-lucide="${gender === 'ប្រុស' ? 'user' : 'user'}" class="w-3 h-3 text-white"></i>
                                    </span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h3 class="text-lg font-bold text-gray-800 truncate" title="${name}">${name}</h3>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-1">ID: <span class="font-mono text-blue-600 font-medium">${id}</span></p>
                                    <div class="flex flex-wrap gap-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            ${studentClass}
                                        </span>
                                        ${year ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700">${year}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-100 grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <p class="text-xs text-gray-400">ភេទ</p>
                                    <p class="font-medium text-gray-700">${gender}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">ជំនាន់</p>
                                    <p class="font-medium text-gray-700">${student['ជំនាន់'] || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-100 bg-gray-50 p-2 min-h-[50px] flex items-center justify-center relative">
                            <!-- Display Mode -->
                            <div id="tg-display-${key}" class="w-full flex items-center justify-between px-2">
                                ${hasTelegram ? `
                                <a href="${telegramLink}" target="_blank" class="flex-1 text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center justify-center gap-2">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                    Telegram
                                </a>
                                ` : `
                                <span class="flex-1 text-gray-400 text-sm text-center">គ្មាន Telegram</span>
                                `}
                                <button onclick="window.toggleEdit('${key}')" class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-100 rounded-full transition-colors ml-2" title="កែប្រែ">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <!-- Edit Mode (Hidden by default) -->
                            <div id="tg-form-${key}" class="hidden w-full flex items-center gap-2">
                                <input type="text" id="tg-input-${key}" value="${telegram}" placeholder="Username ឬ Link..." 
                                    class="flex-1 text-xs px-2 py-1.5 border rounded focus:outline-none focus:border-blue-500 bg-white">
                                <button id="btn-save-${key}" onclick="window.saveTelegram('${key}')" class="p-1.5 bg-green-500 text-white rounded hover:bg-green-600 shadow-sm" title="រក្សាទុក">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.cancelEdit('${key}')" class="p-1.5 bg-gray-300 text-gray-700 rounded hover:bg-gray-400" title="បោះបង់">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
                
                lucide.createIcons();
            }

            // Simple Search
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (window.allStudents) {
                    const filtered = window.allStudents.filter(student => 
                        (student['ឈ្មោះ'] && student['ឈ្មោះ'].toLowerCase().includes(searchTerm)) ||
                        (student['អត្តលេខ'] && String(student['អត្តលេខ']).includes(searchTerm))
                    );
                    renderStudents(filtered);
                }
            });

        } catch (e) {
            console.error("Initialization Error:", e);
            document.getElementById('loading').innerHTML = `
                <div class="col-span-full text-center text-red-500 p-4">
                    Error initializing Firebase: ${e.message}
                </div>
            `;
        }
        
        lucide.createIcons();
    </script>
</body>
</html>
